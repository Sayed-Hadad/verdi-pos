{% extends 'base.html' %}
{% block content %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>إضافة منتج</span>
  </div>
  <div class="card-body">
    <form method="post" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">الاسم</label>
        <input name="name" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">السعر</label>
        <input name="price" type="number" min="0" step="0.01" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">المخزون</label>
        <input name="stock_qty" type="number" min="0" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">حد التنبيه</label>
        <input name="min_stock_alert" type="number" min="0" class="form-control" required>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100">حفظ</button>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>المنتجات</span>
    <small class="text-muted">تعديل / حذف سريع</small>
  </div>
  <div class="card-body p-0">
    <table class="table mb-0 align-middle">
      <thead><tr><th>#</th><th>الاسم</th><th>السعر</th><th>المخزون</th><th>تنبيه</th><th>باركود</th><th class="text-center" style="width:140px">إجراءات</th></tr></thead>
      <tbody>
        {% for p in products %}
        <tr>
          <td>{{ p.id }}</td><td>{{ p.name }}</td><td>{{ '%.2f'|format(p.price) }}</td>
          <td>{{ p.stock_qty }}</td><td>{{ p.min_stock_alert }}</td>
          <td><span class="badge bg-secondary">{{ p.barcode }}</span></td>
          <td class="text-center">
            <button class="btn btn-outline-primary btn-sm edit-btn" 
              data-id="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ p.price }}" 
              data-stock="{{ p.stock_qty }}" data-min="{{ p.min_stock_alert }}">
              تعديل
            </button>
            <form class="d-inline" method="post" action="{{ url_for('main.product_delete', pid=p.id) }}" onsubmit="return confirm('حذف المنتج؟');">
              <button class="btn btn-outline-danger btn-sm">حذف</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center p-3">لا توجد منتجات</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal تعديل المنتج -->
<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تعديل منتج</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="edit-product-form">
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <label class="form-label">الاسم</label>
            <input name="name" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">السعر</label>
            <input name="price" type="number" step="0.01" min="0" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">المخزون</label>
            <input name="stock_qty" type="number" min="0" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">حد التنبيه</label>
            <input name="min_stock_alert" type="number" min="0" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button class="btn btn-primary" type="submit">حفظ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const form = document.getElementById('edit-product-form');
    form.action = `/products/${btn.dataset.id}/update`;
    form.name.value = btn.dataset.name;
    form.price.value = btn.dataset.price;
    form.stock_qty.value = btn.dataset.stock;
    form.min_stock_alert.value = btn.dataset.min;
    const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
    modal.show();
  });
});
</script>
{% endblock %}
