{% extends 'base.html' %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-7">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-primary text-white">ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯Ø©</div>
      <div class="card-body">
        <form id="invoice-form" method="post">
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
              <select class="form-select" name="supplier_id" required>
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>
                {% for s in suppliers %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
              </select>
              <small class="text-muted">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ±Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
              <input class="form-control" name="paid" type="number" min="0" step="0.01" value="0">
              <small class="text-muted">ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ 0 Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ¯ÙØ¹ Ø´ÙŠØ¡</small>
            </div>
          </div>

          <div class="row g-2 align-items-end mb-3">
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
              <select class="form-select" id="product-select">
                <option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬</option>
                {% for p in products %}<option value="{{ p.id }}" data-name="{{ p.name }}">{{ p.name }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-3">
              <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input class="form-control" type="number" id="qty" min="1" value="1">
            </div>
            <div class="col-3">
              <label class="form-label">Ø§Ù„ØªÙƒÙ„ÙØ©</label>
              <input class="form-control" type="number" id="cost" min="0" step="0.01" value="0">
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="button" id="add-item">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØµÙ†Ù</button>
            </div>
          </div>

          <div class="table-responsive mb-3">
            <table class="table table-sm align-middle" id="items-table">
              <thead class="table-light">
                <tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <input type="hidden" name="items_json" id="items-json">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0.00</span> Ø¬.Ù…</strong>
              <span class="badge bg-light text-dark ms-2" id="items-count">0 ØµÙ†Ù</span>
            </div>
            <button class="btn btn-success" type="submit">Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-light">Ø£Ø­Ø¯Ø« ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0 align-middle">
          <thead class="table-light"><tr><th>#</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th class="text-center" style="width:100px">Ø¹Ø±Ø¶</th></tr></thead>
          <tbody>
            {% for inv in invoices %}
            <tr>
              <td>{{ inv.id }}</td>
              <td>{{ supplier_map.get(inv.supplier_id, inv.supplier_id) }}</td>
              <td>{{ '%.2f'|format(inv.total) }}</td>
              <td>{{ '%.2f'|format(inv.paid) }}</td>
              <td>{{ '%.2f'|format(inv.remaining) }}</td>
              <td class="text-center">
                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.supplier_invoice_view', invoice_id=inv.id) }}">Ø¹Ø±Ø¶</a>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center p-3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const items = [];
const tbody = document.querySelector('#items-table tbody');
const totalEl = document.getElementById('total');
const itemsJson = document.getElementById('items-json');

document.getElementById('add-item').addEventListener('click', () => {
  const select = document.getElementById('product-select');
  const pid = select.value;
  const name = select.options[select.selectedIndex]?.dataset?.name || '';
  const qty = parseInt(document.getElementById('qty').value) || 0;
  const cost = parseFloat(document.getElementById('cost').value) || 0;
  if (!pid || qty <= 0) { alert('Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ ÙˆÙƒÙ…ÙŠØ©'); return; }
  const item = {id: Number(pid), name, qty, cost};
  items.push(item);
  renderItems();
});

function renderItems() {
  tbody.innerHTML = '';
  let total = 0;
  items.forEach((it, idx) => {
    const line = it.qty * it.cost;
    total += line;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>${it.qty}</td><td>${it.cost.toFixed(2)}</td><td>${line.toFixed(2)}</td><td><button type="button" class="btn btn-sm btn-outline-danger" data-idx="${idx}">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  totalEl.textContent = total.toFixed(2);
  itemsJson.value = JSON.stringify(items.map(it => ({...it, total: it.qty * it.cost})));
  const countLabel = document.getElementById('items-count');
  if (countLabel) {
    const count = items.length;
    countLabel.textContent = count ? `${count} ØµÙ†Ù` : '0 ØµÙ†Ù';
  }
  tbody.querySelectorAll('button').forEach(btn => btn.onclick = () => { items.splice(Number(btn.dataset.idx),1); renderItems(); });
}

document.getElementById('invoice-form').addEventListener('submit', (e) => {
  if (!items.length) { e.preventDefault(); alert('Ø£Ø¶Ù Ø£ØµÙ†Ø§ÙÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); }
});
</script>
{% endblock %}
